<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="./basti.css" />
    <link rel="stylesheet" href="../styles/board.css" />
    <title>Join Board</title>
  </head>
  <body onload="initBoard()">


    <div id="main-board" class="main-board">
      <div id="head-board" class="head-board">
        <h2>Board</h2>
        <div class="search-container">
          <input type="text" placeholder="Find Task" class="search-input" />
          <button class="search-button">
            Add task
            <img src="./assets/icons/add.svg" alt="" />
          </button>
        </div>
      </div>

      <!--  -->
      <div id="board-main-div" class="board-main-div">
        <div id="to-do-div" class="to-do-div align-all-4">
          <div id="to-do-head" class="all4-style">
            <span>To do</span>
            <img
              class="hover-to-blue"
              src="./assets/icons/add-button-board.svg"
              alt=""
            />
          </div>
          <!--  -->
          <div
            id="todoBoard"
            class="task-section drag-area"
            ondrop="moveTo('todo')"
            ondragleave="removeHighlight('todoBoard')"
            ondragover="allowDrop(event); highlight('todoBoard')"
          >
            <!-- Tasks will be injected here -->
          </div>
        </div>


        <div id="in-progress-div" class="in-progress-div align-all-4">
          <div id="in-progress-head" class="in-progress-head all4-style">
            <span>In progress</span>
            <img
              class="hover-to-blue"
              src="./assets/icons/add-button-board.svg"
              alt=""
            />
          </div>

          <div
            id="inProgressBoard"
            class="task-section drag-area"
            ondrop="moveTo('inProgress')"
            ondragleave="removeHighlight('inProgressBoard')"
            ondragover="allowDrop(event); highlight('inProgressBoard')"
          >
            <!-- Tasks will be injected here -->
          </div>
        </div>

        <!--  -->
        <div id="await-feedback-div" class="await-feedback-div align-all-4">
          <div id="await-feedback-head" class="all4-style">
            <span>Await feedback</span>
            <img
              class="hover-to-blue"
              src="./assets/icons/add-button-board.svg"
              alt=""
            />
          </div>
          <div
            id="awaitFeedbackBoard"
            class="task-section drag-area"
            ondrop="moveTo('awaitFeedback')"
            ondragleave="removeHighlight('awaitFeedbackBoard')"
            ondragover="allowDrop(event); highlight('awaitFeedbackBoard')"
          >
            <!-- Tasks will be injected here -->
          </div>
        </div>


        <!--  -->
        <div id="done-div" class="done-div align-all-4">
          <div id="done-head" class="all4-style">
            <span>Done</span>
          </div>
          <div
            id="doneBoard"
            class="task-section drag-area"
            ondrop="moveTo('done')"
            ondragleave="removeHighlight('doneBoard')"
            ondragover="allowDrop(event); highlight('doneBoard')"
          >
            <!-- Tasks will be injected here -->
          </div>
        </div>
      </div>
    </div>
    <script src="../js/firebase.js"></script>
    <script>
      let currentDraggedElement = null;

      async function initBoard() {
        await loadTasks(); // Daten von Firebase laden
        updateBoard(); // Board aktualisieren
      }

      function calculateProgress(completedSubtasks, subtaskCount) {
        return (completedSubtasks / subtaskCount) * 100;
      }

      // function getCategoryStyle(category) {
      //     switch (category) {
      //         case "User Story":
      //             return { labelClass: "user-story-label", labelText: "User Story" };
      //         case "Technical Task":
      //             return { labelClass: "technical-task-label", labelText: "Technical Task" };
      //         default:
      //             return { labelClass: "default-label", labelText: category };
      //     }
      // }

      function updateBoard() {
        renderBoard("todo", "todoBoard");
        renderBoard("inProgress", "inProgressBoard");
        renderBoard("awaitFeedback", "awaitFeedbackBoard");
        renderBoard("done", "doneBoard");
      }

      function renderBoard(statusType, boardElementId) {
        let filteredTasks = tasks.filter((t) => t.status === statusType);
        let content = document.getElementById(boardElementId);
        content.innerHTML = "";

        if (filteredTasks.length === 0) {
          content.innerHTML = `<div class="no-task-available">No tasks ${statusType
            .replace(/([A-Z])/g, " $1")
            .toLowerCase()}</div>`;
        } else {
          filteredTasks.forEach((element) => {
            element.progress = calculateProgress(
              element.completedSubtasks,
              element.subtaskCount
            );
            // const categoryStyle = getCategoryStyle(element.category);
            // element.labelClass = categoryStyle.labelClass;
            // element.labelText = categoryStyle.labelText;
            content.innerHTML += generateTaskCardHTML(element);
          });
        }
      }

      function generateTaskCardHTML(element) {
        return `
        <div class="task-card" draggable="true" ondragstart="startDragging('${
          element.idNumber
        }')" onclick="openDetailedTaskOverlay('${element.idNumber}')">
            <div class="task-label ${
              element.category === "UserStory"
                ? "user-story"
                : element.category === "TechnicalTask"
                ? "technical-task"
                : "default-label"
            }">${element.category}</div>
            <div class="task-title">${element.title}</div>
            <div class="task-description">${element.description}</div>
            
            <div class="task-subtasks">
                <div class="progress-bar">
                    <div class="progress" style="width: ${
                      element.progress
                    }%;"></div>
                </div>
                <div class="subtask-info">${element.completedSubtasks}/${
          element.subtaskCount
        } Subtasks</div>
            </div>
            
            <div class="task-footer">
                <div class="task-assigned">
                    ${element.assignedTo
                      .map((person) => `<span class="avatar">${person}</span>`)
                      .join("")}
                </div>
                <div class="priority-icon ${element.priority}"></div>
            </div>
        </div>`;
      }

      function startDragging(id) {
        currentDraggedElement = id;
      }

      function allowDrop(ev) {
        ev.preventDefault();
      }

      function moveTo(category) {
        let task = tasks.find((t) => t.idNumber === currentDraggedElement);
        if (task) {
          task.status = category;
          updateBoard();
        }
      }

      function highlight(id) {
        document.getElementById(id).classList.add("drag-area-highlight");
      }

      function removeHighlight(id) {
        document.getElementById(id).classList.remove("drag-area-highlight");
      }

      function openDetailedTaskOverlay(taskId) {        
        // Implementiere hier die Logik, um ein detailliertes Overlay anzuzeigen.
      }
    </script>
  </body>
</html>
